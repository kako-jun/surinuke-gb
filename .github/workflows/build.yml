name: Build Game Boy ROM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup GBDK
      run: |
        wget https://github.com/gbdk-2020/gbdk-2020/releases/download/4.1.1/gbdk-linux64.tar.gz
        tar -xzf gbdk-linux64.tar.gz
        export GBDK_HOME="$PWD/gbdk"
        echo "GBDK_HOME=$GBDK_HOME" >> "$GITHUB_ENV"
        echo "GBDKDIR=$GBDK_HOME" >> "$GITHUB_ENV" # lcc uses GBDKDIR as base path
        echo "$GBDK_HOME/bin" >> "$GITHUB_PATH"

    - name: Build ROM
      run: |
        export GBDKDIR="${GBDKDIR:-$GITHUB_WORKSPACE/gbdk}"
        export PATH="$GBDKDIR/bin:$PATH"
        make

    - name: Upload ROM artifact
      uses: actions/upload-artifact@v4
      with:
        name: surinuke-gb-rom
        path: surinuke-gb.gb
        if-no-files-found: error
